
&НаКлиенте
Процедура РассчитатьВзаимозачет(Команда)
	Если Объект.Проведен Тогда
		Сообщить("Рассчитать взаимозачет можно только в не проведенном документе!");
		Возврат;
	КонецЕсли;
	
	Объект.ЗадолженностьДебитора.Очистить();
	Объект.ЗадолженностьКредитора.Очистить();
	РассчитатьВзаимозачетНаСервере();
КонецПроцедуры

&НаСервере
Процедура РассчитатьВзаимозачетНаСервере()
	// Вставить содержимое обработчика.
	
	// расчет дебиторки
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВзаиморасчетыСКлиентамиОстатки.СуммаОстаток КАК Сумма,
	               |	ВзаиморасчетыСКлиентамиОстатки.РасчетныйДокумент
	               |ИЗ
	               |	РегистрНакопления.ВзаиморасчетыСКлиентами.Остатки(&ДатаДок, Партнер = &Дебитор) КАК ВзаиморасчетыСКлиентамиОстатки
	               |ГДЕ
	               |	ВзаиморасчетыСКлиентамиОстатки.СуммаОстаток > 0
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВзаиморасчетыСКлиентамиОстатки.РасчетныйДокумент.Дата";
	Запрос.УстановитьПараметр("Дебитор", Объект.Дебитор);
	Запрос.УстановитьПараметр("ДатаДок", Объект.Дата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НовД = Объект.ЗадолженностьДебитора.Добавить();
		НовД.ТипРасчетов = Перечисления.ТипРасчетов.РасчетыСКлиентом;
		НовД.РасчетныйДокумент = Выборка.РасчетныйДокумент;
		НовД.Сумма = Выборка.Сумма;
	КонецЦикла;
	
	
	// расчет дебиторки
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВзаиморасчетыСКлиентамиОстатки.СуммаОстаток КАК Сумма,
	               |	ВзаиморасчетыСКлиентамиОстатки.РасчетныйДокумент
	               |ИЗ
	               |	РегистрНакопления.ВзаиморасчетыСКлиентами.Остатки(&ДатаДок, Партнер = &Дебитор) КАК ВзаиморасчетыСКлиентамиОстатки
	               |ГДЕ
	               |	ВзаиморасчетыСКлиентамиОстатки.СуммаОстаток < 0
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВзаиморасчетыСКлиентамиОстатки.РасчетныйДокумент.Дата";
	Запрос.УстановитьПараметр("Дебитор", Объект.Кредитор);
	Запрос.УстановитьПараметр("ДатаДок", Объект.Дата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НовД = Объект.ЗадолженностьКредитора.Добавить();
		НовД.ТипРасчетов = Перечисления.ТипРасчетов.РасчетыСКлиентом;
		НовД.РасчетныйДокумент = Выборка.РасчетныйДокумент;
		НовД.Сумма = - Выборка.Сумма;
	КонецЦикла;

	
КонецПроцедуры
